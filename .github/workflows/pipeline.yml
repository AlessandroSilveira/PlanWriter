name: PlanWriter Pipeline

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: planwriter-main-pipeline
  cancel-in-progress: true

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore
        run: dotnet restore PlanWriter.sln

      - name: Build
        run: dotnet build PlanWriter.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test PlanWriter.Tests/PlanWriter.Tests.csproj --configuration Release --no-build --verbosity normal

  deploy:
    name: Deploy (Docker Compose via SSH)
    runs-on: ubuntu-latest
    needs:
      - test
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          script_stop: true
          script: |
            set -euo pipefail

            DEPLOY_ROOT="${{ secrets.DEPLOY_ROOT }}"
            if [ -z "$DEPLOY_ROOT" ]; then
              echo "Secret DEPLOY_ROOT nao configurado."
              exit 1
            fi

            BACKEND_DIR="$DEPLOY_ROOT/PlanWriter"
            FRONTEND_DIR="$DEPLOY_ROOT/PlanWriter-Frontend"

            if [ ! -d "$BACKEND_DIR/.git" ]; then
              echo "Repositorio backend nao encontrado em: $BACKEND_DIR"
              exit 1
            fi

            if [ ! -d "$FRONTEND_DIR/.git" ]; then
              echo "Repositorio frontend nao encontrado em: $FRONTEND_DIR"
              exit 1
            fi

            git -C "$BACKEND_DIR" checkout main
            git -C "$BACKEND_DIR" pull --ff-only origin main

            git -C "$FRONTEND_DIR" checkout main
            git -C "$FRONTEND_DIR" pull --ff-only origin main

            docker compose -f "$BACKEND_DIR/docker-compose.yml" up -d --build
            docker compose -f "$BACKEND_DIR/docker-compose.yml" ps
